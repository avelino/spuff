name: E2E Tests

on:
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  e2e-docker:
    name: E2E Tests (Docker)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # ChronDB uses GraalVM native-image which requires large stack (~32MB).
    # Tests are informational until ChronDB resolves this limitation.
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-e2e-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-e2e-

      - name: Cache ChronDB native library
        uses: actions/cache@v4
        with:
          path: ~/.chrondb/lib/
          key: ${{ runner.os }}-chrondb-lib-v4

      - name: Build release binaries
        run: cargo build --release

      - name: Setup spuff config
        run: |
          mkdir -p ~/.spuff ~/.ssh
          ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -N "" -q
          cat > ~/.spuff/config.yaml << 'EOF'
          provider: docker
          ssh_key_path: ~/.ssh/id_ed25519
          ssh_user: dev
          idle_timeout: 30m
          region: local
          size: default
          environment: devbox
          volumes: []
          EOF
          sed -i 's/^          //' ~/.spuff/config.yaml

      # ============================================
      # Basic CLI tests
      # ============================================
      - name: Test CLI basics
        run: |
          ./target/release/spuff --version
          ./target/release/spuff --help
          ./target/release/spuff status

      # ============================================
      # Docker provider tests
      # ============================================
      - name: Pull Docker image
        run: docker pull ubuntu:24.04

      - name: Test spuff up
        timeout-minutes: 5
        run: |
          ./target/release/spuff up --no-connect
          echo "Instance created successfully"

      - name: Test status and exec
        timeout-minutes: 2
        run: |
          ./target/release/spuff status
          ./target/release/spuff status --detailed
          ./target/release/spuff exec "echo 'Hello from E2E test'"
          ./target/release/spuff exec "whoami"
          ./target/release/spuff exec "pwd"
          ./target/release/spuff exec "cat /etc/os-release | head -5"

      - name: Test agent commands
        timeout-minutes: 2
        run: |
          ./target/release/spuff agent status
          ./target/release/spuff agent metrics
          ./target/release/spuff agent processes

      - name: Test logs and volumes
        timeout-minutes: 2
        run: |
          ./target/release/spuff logs --lines 10 || true
          ./target/release/spuff volume ls
          ./target/release/spuff volume status || true

      - name: Test file operations
        timeout-minutes: 2
        run: |
          ./target/release/spuff exec "echo 'test content' > /tmp/e2e-test.txt"
          CONTENT=$(./target/release/spuff exec "cat /tmp/e2e-test.txt")
          [[ "$CONTENT" == *"test content"* ]] || exit 1
          ./target/release/spuff exec "mkdir -p /tmp/e2e-dir/subdir"
          ./target/release/spuff exec "touch /tmp/e2e-dir/subdir/file.txt"
          ./target/release/spuff exec "ls -la /tmp/e2e-dir/subdir/"

      - name: Test exit codes
        timeout-minutes: 2
        run: |
          ./target/release/spuff exec "true"
          ! ./target/release/spuff exec "false"

      - name: Test spuff down
        timeout-minutes: 2
        run: |
          ./target/release/spuff down --force
          ./target/release/spuff status 2>&1 | grep -q "No active environment"

      # ============================================
      # Project config tests (spuff.yaml)
      # ============================================
      - name: Create test project
        run: |
          mkdir -p /tmp/test-project
          cat > /tmp/test-project/spuff.yaml << 'EOF'
          name: e2e-test-project
          packages:
            - curl
            - jq
          setup:
            - echo "Setup executed" > /tmp/setup-marker.txt
          env:
            E2E_TEST_VAR: "hello-from-e2e"
          EOF

      - name: Test spuff up with project config
        timeout-minutes: 5
        working-directory: /tmp/test-project
        run: ${{ github.workspace }}/target/release/spuff up --no-connect

      - name: Verify project packages installed
        timeout-minutes: 2
        working-directory: /tmp/test-project
        run: |
          ${{ github.workspace }}/target/release/spuff exec "which curl"
          ${{ github.workspace }}/target/release/spuff exec "which jq"
          ${{ github.workspace }}/target/release/spuff status --detailed

      - name: Cleanup project
        timeout-minutes: 2
        working-directory: /tmp/test-project
        run: ${{ github.workspace }}/target/release/spuff down --force
